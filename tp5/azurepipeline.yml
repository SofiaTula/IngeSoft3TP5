trigger:
  - main

pool:
  name: SelfHosted

stages:
  - stage: CI
    displayName: "Continuous Integration"
    jobs:
      - job: Backend
        displayName: "Backend CI"
        services:
          mysql:
            image: mysql:8.0
            env:
              MYSQL_ROOT_PASSWORD: root
              MYSQL_DATABASE: coffeehub
            ports:
              - 3306:3306
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '18.x'

          - script: |
              cd coffehub/backend
              npm install
            displayName: "Install Backend"

          - script: |
              cd coffehub/backend
              # Esperar un poco a que MySQL arranque
              sleep 20
              # Exportar variables para el backend
              export DB_HOST=localhost
              export DB_USER=root
              export DB_PASS=root
              export DB_NAME=coffeehub
              npm test || echo "No tests definidos (skipped)"
            displayName: "Run Backend Tests (Optional)"
            continueOnError: true

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: 'coffehub/backend'
              ArtifactName: 'backend'
              publishLocation: 'Container'
            displayName: "Publicar artefacto Backend"

      - job: Frontend
        displayName: "Frontend CI"
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '18.x'

          - script: |
              cd coffehub/frontend
              npm install || true
              npm run build || echo "No build script definido"
            displayName: "Build Frontend"

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: 'coffehub/frontend'
              ArtifactName: 'frontend'
              publishLocation: 'Container'
            displayName: "Publicar artefacto Frontend"